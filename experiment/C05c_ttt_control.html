<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <script src="./jspsych.js"></script>
    <script src="./plugins/plugin-preload.js"></script>
    <script src="./plugins/plugin-survey-html-form.js"></script>
    <script src="./plugins/plugin-html-keyboard-response.js"></script>
    <script src="./plugins/plugin-html-button-response.js"></script>
    <script src="./plugins/plugin-survey-text.js"></script>
    <script src="./plugins/plugin-fullscreen.js"></script>
    <script src="./plugins/plugin-survey-likert.js"></script>
    <script src="./plugins/plugin-instructions.js"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="./css/jspsych.css" />
  </head>
  <body></body>
  <script>
/*
　C05c_ttt_control.html
　- 認知科学の資料論文に公開するcontrol条件の執筆課題
*/

let writing_start_time;
let probe_timer;
let submit_timer;
let end_timer;
let responses_log = [];
let response_log_order = 0;//何個目のデータか一応控える
let response_log_json_string;
let beep_start_time = null;
let response_time_for_beep;
let beep_active = false;
let trial_text = "";
let pre_writing_pause;//ここで事前に宣言しておく(20250801)
const beep_audio = new Audio('./stimulus/beep.mp3');

//時間管理
let writing_duration;
let writing_duration_rt;
let submit_button_time; // 1分後に提出ボタンを表示（本当は12分間）
let trial_duration_outline; // 1分後にアウトライン終了（本当は8分間）
let totalTime; //trial_duration_outline秒
let probe_interval;//先に宣言しておく

let isTaskMain = false;//taskの量をデバッグと本番の切り替え

if (isTaskMain){//本番
  writing_duration = 20 * 60 * 1000; // 20分
  submit_button_time = 8 * 60 * 1000; // 8分後に提出ボタンを表示
  trial_duration_outline = 8 * 60 * 1000; // 8分後にアウトライン終了
  totalTime = trial_duration_outline / 1000; //trial_duration_outline秒

  function reset_probe_interval(){
    return Math.floor(Math.random() * (45 - 15 + 1) + 15) * 1000;//// 15〜45秒の一様分布 → 平均30秒
  };
} else {//デバッグ用
  writing_duration = 0.5 * 60 * 1000; // 20分 -> 0.5分でデバッグ（7/29）
  submit_button_time = 0.1 * 60 * 1000; // 0.5分後に提出ボタンを表示
  trial_duration_outline = 0.1 * 60 * 1000; // 1分後にアウトライン終了
  totalTime = trial_duration_outline / 1000; //trial_duration_outline秒

  function reset_probe_interval(){
    return Math.floor(Math.random() * (20 - 10 + 1) + 5) * 1000;//// 5〜15秒の一様分布 → 平均15秒
  };
}

$(document).on('keydown', function(e){
  if ((e.which || e.keyCode) == 9) {
    return false;
  }
});

//音声ファイルを事前に読み込んでおく
const preload = {
  type: jsPsychPreload,
  audio: ['./stimulus/beep.mp3']
};


jsPsych = initJsPsych({
  on_finish: () => {
    //終了時にローカルに出力（確認用）
    jsPsych.data.get().localSave("csv", "./C05c_ttt_control.csv");
  },
});

//実験開始時間の記録
const ex_start_time = new Date();
const ex_start_time_text = ex_start_time.getFullYear()+"/"+(ex_start_time.getMonth()+1)+"/"+ex_start_time.getDate()+ " "+ ex_start_time.getHours()+":"+("0" + ex_start_time.getMinutes()).slice(-2)+":"+("0" + ex_start_time.getSeconds()).slice(-2);
jsPsych.data.addProperties({"StartTime":ex_start_time_text});//参加者情報に格納

//実験画面を全画面表示にする
//フルスクリーンで実験を始める
const FullScreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: true,
    message:"これから実験を始めます。実験はフルスクリーンで行われます。<br>"+
    "（フルスクリーン非対応ブラウザの場合を除く）<br>"+
    "*なお、実験を途中でやめる場合は、Escキーを押すことでフルスクリーンを解除することができます。<br><br>"+
    "「次へ」ボタンを押すと次に進みます。<br><br>",
    button_label:"次へ",
    delay_after:1000,
    data: { task: 'FullScreen' },
};

main_task_inst = [
  `
    <p style="text-align: left">※これ以降の課題ではヘッドホンあるいは音が聞きやすいデバイスを装着して取り組んでください。</p>
    <p style="text-align: left">※普段、パソコンを使って文字を入力する時のように、手をキーボードにおいて課題に取り組んでください。</p>
    <p style="text-align: left"><b>※以降の課題において、生成AIの利用を禁じます。入力内容から生成AIを使用していることが確認された場合、謝金が支払われないことがあります。</b></p>
    <p><br></p>
    <p style="text-align: left">本研究における、あなたの現在の課題を太字で示しています。</p>
    <ul style="text-align: left;">
      <li style='color:gray'>あなた自身についての質問 (所要時間：5分程度)</li>
      <li style='color:gray'>刺激に対する反応の速さの課題（所要時間: 5分程度）</li>
      <li style='color:gray'>文章産出中の思考に関する課題（所要時間: 5分程度）</b></li>
      <li style='color:gray'>事前課題（所要時間: 10分程度）</li>
      <li><b>文章産出課題（所要時間: 20分程度）</b></li>
    </ul>
  `,
  `
    <p style="text-align: left">次のスライドからは、<strong>あなたが考えたオリジナルの面白い物語を書いていただきます。</strong></p>
      <br>あなたが考えた面白い物語を画面の右半分に呈示されているテキストボックスに入力してください。</p>
  `,
  `
    <p style="text-align: left">ただし、あなたは物語を書くことと並行して、<u>ビープ音が聞こえたら可能な限り素早くTabキーを押し、<br>
      その時に考えていたことを「プラニング」「出力」「修正」そして「その他」で回答してもらう課題を行なってもらいます。</u></p>
    <p style="text-align: left">選択肢は、ビープ音がなってTabキーを押すと<br>
      画面右側のテキストボックスの真下に提示されるので、
      ボタンを押すことで回答してください。<br>
    <p style="text-align: left">つまり、あなたには<b><u>「文章を書く」「ビープ音がなったらTabキーを押す」「その時に考えていたことを選択肢で回答する」<br>
      そしてまた文章を書く課題に取り組んでいただきます。</b></u></p>
  `
  ,
  `
    <p style="text-align: left"><b>課題は20分間で強制的に次に進みます。</b></p>
    <p style="text-align: left">また、8分間が経過すると「この内容で提出」というボタンが画面右上に提示されますので、<br>
      物語を描き終えた方はこのボタンを押して、次に進んでも構いません。</p>
    <p><br><br></p>
    <p style="text-align: left">課題の準備ができたら「次へ」ボタンを押して、本番に進んでください。</p>
  `
]

const main_task_inst_tl = {
  type: jsPsychInstructions,
  pages: main_task_inst,
  show_clickable_nav: true,
  button_label_previous: "前へ",
  button_label_next: "次へ",
  data: { task: 'main_task_inst_tl' },
};

const writing_screen = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: () => {
    return `
      <div style="display: flex; flex-direction: row; gap: 10px; height: 90vh; width: 90vw; padding: 0 5px; box-sizing: border-box;">
        <!-- 左側：白紙 -->
        <div style="width: 50%; border-right: 1px solid #ccc; padding: 10px; overflow-y: scroll; background-color: white;"></div>

        <!-- 右側：回答エリア、タイマー、次へボタン -->
        <div style="width: 50%; padding: 10px; display: flex; flex-direction: column; height: 100 %; box-sizing: border-box;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <p id="writing_instruction">オリジナルの面白い物語を書いてください：</p>
            <p id="countdown_timer" style="font-weight: bold;"></p>
            <button id="submit_button" disabled>この内容で提出</button>
          </div>

          <textarea id="writing_area" style="flex-grow: 1; resize: none; width: 100%; height: 100%; font-size: 1.05em;"></textarea>
          <div style="margin-top: 10px;">
            <div id="probe_instruction" style="display:none;">
              <p style="color: red; font-weight: bold;">ビープ音が鳴りました！Tabキーを押してください。</p>
            </div>
            <div id="response_buttons" style="display:none; margin-top:10px;">
              <p>どの段階で中断したかを選んでください：</p>
              <button class="resp" data-response="planning">プランニング</button>
              <button class="resp" data-response="output">出力</button>
              <button class="resp" data-response="revision">修正</button>
              <button class="resp" data-response="other">その他</button>
            </div>
          </div>
        </div>
      </div>
    `;
  },
  choices: "NO_KEYS",

  on_load: () => {
    //開始時間の記録
    writing_start_time = Date.now();

    //最初の文字入力の識別
    let firstCharTime = null;
    const submitButton = document.getElementById('submit_button');
    
    //文字入力が起こったらtrial_text
    //最新のテキストはtrial_textで管理して、画面終了時に他の変数に渡す
    let textarea = document.getElementById('writing_area');
    textarea.addEventListener('input', () => {
        //もし文字入力が最初だったら、その情報を保存する
        if (!firstCharTime && textarea.value.trim().length > 0) {
          firstCharTime = Date.now();
        };
      trial_text = textarea.value;
    });

    //ビープ音のコントロール
    schedule_probe();
    document.addEventListener('keydown', handleBeepKey);
    document.querySelectorAll('.resp').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const response = e.target.getAttribute('data-response');

        //response_logに結果を溜め込む
        //追記(2025/8/3): probe_intervalも追加する
        responses_log.push({
          order: response_log_order,
          time: Date.now() - writing_start_time,
          probe_interval: probe_interval,
          response: response,
          response_time_for_beep: response_time_for_beep,
          trial_text: trial_text,
        });

        //JSON文字列に変換する
        //ref: https://x-tech.pasona.co.jp/media/detail.html?p=2410
        response_log_json_string = JSON.stringify(responses_log);

        //response_log_json_stringをコンソールに出力する
        //必要ならここにSQLへの保存用のコードを書く
        console.log(response_log_json_string);

        //responses_logを空にして,orderを更新する。
        responses_log = [];
        response_log_order += 1;

        enableTextarea();
        document.getElementById('response_buttons').style.display = 'none';
        document.getElementById('writing_instruction').innerText = 'オリジナルの面白い物語を書いてください：';
        beep_active = false;
        schedule_probe();
      });
    });

    //提出ボタンをsubmit_button_timeが過ぎたら使えるようにする
    submit_timer = setTimeout(() => {
      document.getElementById("submit_button").removeAttribute("disabled");
    }, submit_button_time);

    //countdown_timerの表示内容と動作
    let timer_interval = setInterval(() => {
      let elapsed = Date.now() - writing_start_time;
      let remaining = writing_duration - elapsed;
      
      if (remaining < 0) {
        //2025/8/1追記
        //時間切れで保存して終了
        clearTimeout(submit_timer);
        clearInterval(timer_interval);
        clearTimeout(probe_timer);
        writing_duration_rt = Date.now() - writing_start_time;
        pre_writing_pause = firstCharTime ? firstCharTime - writing_start_time : null;
        jsPsych.finishTrial();
      }

      let minutes = Math.floor(remaining / 60000);
      let seconds = Math.floor((remaining % 60000) / 1000);

      //もしタイマーがあればタイマーを更新
      if (document.getElementById('countdown_timer')) {
        document.getElementById('countdown_timer').textContent = `あと${minutes.toString().padStart(2, '0')}分:${seconds.toString().padStart(2, '0')}秒`;
      }
    }, 1000);

    // 「この内容で提出」ボタンが押されたら実験終了
    submitButton.addEventListener('click', () => {
      //2025/8/1追記
      clearTimeout(submit_timer);
      clearInterval(timer_interval);
      clearTimeout(probe_timer);
      writing_duration_rt = Date.now() - writing_start_time;
      pre_writing_pause = firstCharTime ? firstCharTime - writing_start_time : null;
      jsPsych.finishTrial();
    });
  },
  on_finish: function(data){
    data.task = 'writing_block';
    data.writing_txt = trial_text;
    data.writing_duration_rt = writing_duration_rt;
    data.pre_writing_pause = pre_writing_pause;
  }
};

function schedule_probe() {     
  // probe_interval を毎回ランダムに再設定
  probe_interval = reset_probe_interval();

  probe_timer = setTimeout(() => {  
    beep_audio.play();
    beep_start_time = Date.now();
    beep_active = true;
    disableTextarea();
    document.getElementById('writing_instruction').innerText = 'ビープ音が鳴りました！Tabキーを押してください。';
  }, probe_interval);
}

function handleBeepKey(e) {
  if (e.code === 'Tab' && beep_active) {
    response_time_for_beep = Date.now() - beep_start_time;
    document.getElementById('probe_instruction').style.display = 'none';
    document.getElementById('response_buttons').style.display = 'block';
    beep_active = false;
    e.preventDefault();
  }
}

function disableTextarea() {
  const ta = document.getElementById('writing_area');
  if (ta) ta.setAttribute('disabled', 'true');
}

function enableTextarea() {
  const ta = document.getElementById('writing_area');
  if (ta) ta.removeAttribute('disabled');
}

const debrief = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus:
    "<p style='text-algin:left'>これで実験は終了です。お疲れ様でした。</p>" +
    "<p style='text-algin:left'>スペースキーを押して、謝金の支払いに関わる最後の質問に移行してください。</p>",
  choices: [' '],
  data: { task: 'debrief' },
  on_finish:function(data){
    const ex_finish_time = new Date();
    const ex_finish_time_text = ex_finish_time.getFullYear()+"/"+(ex_finish_time.getMonth()+1)+"/"+ex_finish_time.getDate()+ " "+ ex_finish_time.getHours()+":"+("0" + ex_finish_time.getMinutes()).slice(-2)+":"+("0" + ex_finish_time.getSeconds()).slice(-2);
    jsPsych.data.addProperties({"EndTime":ex_finish_time_text});
  }
};

jsPsych.run([
  preload,
  FullScreen,
  main_task_inst_tl,
  writing_screen,
  debrief
]);

</script>
</html>

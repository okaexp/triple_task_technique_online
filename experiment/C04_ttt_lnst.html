<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <script src="./jspsych.js"></script>
    <script src="./plugins/plugin-survey-html-form.js"></script>
    <script src="./plugins/plugin-html-keyboard-response.js"></script>
    <script src="./plugins/plugin-html-button-response.js"></script>
    <script src="./plugins/plugin-survey-text.js"></script>
    <script src="./plugins/plugin-fullscreen.js"></script>
    <script src="./plugins/plugin-instructions.js"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="./css/jspsych.css" />
  </head>
  <body></body>
  <script>
/*
　C04_ttt_lnst.html
　- 認知科学の資料論文に公開するLetter Number Sequence test
*/

let isTaskMain = false;//taskの量をデバッグと本番の切り替え

$(document).on('keydown', function(e){
  if ((e.which || e.keyCode) == 9) {
    return false;
  }
});

jsPsych = initJsPsych({
  on_finish: () => {
    //DBにデータを送りたい場合はこの部分にsaveDatatoMysql()のような関数を自作して入れる
    //今回は実験終了後に、ダウンロードにcsv出力する
    jsPsych.data.get().localSave("csv", "./C04_ttt_lnst.csv");
  },
});

// --- LNSTの試行を作る関数 ---
function generateTrial(stimulusArray, correctAnswer, giveFeedback = false) {
    //練習試行とそれ以外の区別
    let task_name_presentation;
    let task_name_response;
    //feedbackがあるのはpractice
    if (giveFeedback) {
      task_name_presentation = "presentation_trials_practice";
      task_name_response = "response_trials_practice";
    } else {
      task_name_presentation = "presentation_trials_main";
      task_name_response = "response_trials_main";
    }

    const presentation_trials = stimulusArray.map((char) => {
        return {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<div style="font-size: 48px;">${char}</div>`,
            choices: "NO_KEYS",
            trial_duration: 1000,
            data: { task: `${task_name_presentation}` },
        };
    })

    const trial_timeline = {
        timeline: [
            //文字の呈示
            ...presentation_trials,
            //blank screen
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: "",
                choices: "NO_KEYS",
                trial_duration: 1000,
            },
            // response screen
            // stimulusのinputのonipnutプロパティで大文字に変換するように変更
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `
                    <p>数字を小さい順にならべかえて、アルファベットをアルファベット順に並び替えた文字列を、回答欄に入力してください。</p>
                    <input type="text" id="response-input" style="font-size: 20px;" required autofocus oninput="
                    this.value = this.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                    ">
                    <br><br>
                    <button id="submit-btn" disabled>次の問題に進む</button>
                `,
                choices: "NO_KEYS",
                data: { task: `${task_name_response}` },

                on_load: () => {
                    //入力フォームとボタンの準備
                    const input = document.getElementById('response-input');
                    const button = document.getElementById('submit-btn');

                    //inputに変化があったら
                    input.addEventListener('input', () => {
                        button.disabled = input.value.length === 0;
                    });

                    //ボタンが押されたら正規化された文字列を保存
                    button.addEventListener('click', () => {
                        const raw = input.value;
                        const normalized = raw.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();

                        jsPsych.finishTrial({
                            response_raw: raw,
                            response_normalized: normalized,
                            correct_answer: `${correctAnswer}`,
                            correct: normalized === `${correctAnswer}`
                        });
                    });
                }
            },
        ]
    };
    // 練習思考でのみgiveFeedback = trueでtimelineに追加
    if (giveFeedback) {
        trial_timeline.timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            trial_duration: 2000,
            stimulus: () => {
                const lastTrial = jsPsych.data.get().last(1).values()[0];
                return lastTrial.correct
                ? "<p style='color:green; font-size: 48px;'>正解です！</p>"
                : `<p style='color:red; font-size: 48px;'>不正解です。正しい答えは <code>${correctAnswer}</code> です。</p>`;
            },
            choices: "NO_KEYS",
        })
    };

    return trial_timeline;
};

// --- 練習試行（3〜4桁） ---
const practice_trials = [
  //3桁2問 + 4桁2問
  { stimulus: ["C", "2", "A"], correct: "2AC", giveFeedback: true},
  { stimulus: ["B", "5", "D"], correct: "5BD", giveFeedback: true},
  { stimulus: ["1", "G", "C", "7"], correct: "17CG", giveFeedback: true},
  { stimulus: ["F", "6", "A", "2"], correct: "26AF", giveFeedback: true},
];

// --- 本番試行 ---
// debugとmainを切り分け
let main_trials;
if(isTaskMain){
  main_trials = [
    //4桁
    { stimulus: ["D", "3", "B", "1"], correct: "13BD", giveFeedback: false},
    { stimulus: ["A", "7", "4", "F"], correct: "47AF", giveFeedback: false},
    { stimulus: ["2", "G", "E", "5"], correct: "25EG", giveFeedback: false},

    // 5桁
    { stimulus: ["D", "3", "B", "7", "A"], correct: "37ABD", giveFeedback: false},
    { stimulus: ["F", "2", "K", "5", "C"], correct: "25CFK", giveFeedback: false},
    { stimulus: ["4", "M", "H", "1", "E"], correct: "14EHM", giveFeedback: false},

    // 6桁
    { stimulus: ["G", "9", "2", "L", "A", "5"], correct: "259AGL", giveFeedback: false},
    { stimulus: ["3", "B", "N", "7", "D", "F"], correct: "37BDFN", giveFeedback: false},
    { stimulus: ["E", "6", "1", "Q", "H", "8"], correct: "168EHQ", giveFeedback: false},

    // 7桁
    { stimulus: ["C", "4", "T", "K", "2", "A", "9"], correct: "249ACKT", giveFeedback: false},
    { stimulus: ["6", "Z", "R", "3", "B", "J", "M"], correct: "36BJMRZ", giveFeedback: false},
    { stimulus: ["L", "5", "1", "G", "X", "D", "7"], correct: "157DGLX", giveFeedback: false},
  ];} else {
  main_trials = [
    //2試行だけ
    { stimulus: ["D", "3", "B", "1"], correct: "13BD", giveFeedback: false},
    { stimulus: ["A", "7", "4", "F"], correct: "47AF", giveFeedback: false},
  ];
} 

//実験開始時間の記録
const ex_start_time = new Date();
const ex_start_time_text = ex_start_time.getFullYear()+"/"+(ex_start_time.getMonth()+1)+"/"+ex_start_time.getDate()+ " "+ ex_start_time.getHours()+":"+("0" + ex_start_time.getMinutes()).slice(-2)+":"+("0" + ex_start_time.getSeconds()).slice(-2);
jsPsych.data.addProperties({"StartTime":ex_start_time_text});//参加者情報に格納

//実験画面を全画面表示にする
//フルスクリーンで実験を始める
const FullScreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: true,
    message:"これから実験を始めます。実験はフルスクリーンで行われます。<br>"+
    "（フルスクリーン非対応ブラウザの場合を除く）<br>"+
    "*なお、実験を途中でやめる場合は、Escキーを押すことでフルスクリーンを解除することができます。<br><br>"+
    "「次へ」ボタンを押すと次に進みます。<br><br>",
    button_label:"次へ",
    delay_after:1000,
    data: { task: 'FullScreen' },
};

practice_task_inst = [
  `
    <p style="text-align: left">※これ以降の課題ではヘッドホンあるいは音が聞きやすいデバイスを装着して取り組んでください。</p>
    <p style="text-align: left">※普段、パソコンを使って文字を入力する時のように、手をキーボードにおいて課題に取り組んでください。</p>
    <p><br></p>
    <p style="text-align: left">本研究における、あなたの現在の課題を太字で示しています。</p>
    <ul style="text-align: left;">
      <li style='color:gray'>あなた自身についての質問 (所要時間：5分程度)</li>
      <li style='color:gray'>刺激に対する反応の速さの課題（所要時間: 5分程度）</li>
      <li style='color:gray'>文章産出中の思考に関する課題（所要時間: 5分程度）</li>
      <li><b>事前課題（所要時間: 10分程度）</b></li>
      <li>文章産出課題（所要時間: 20分程度）</li>
    </ul>
  `,
  `
    <p style="text-align: left">これから、数字とアルファベットの文字が混ざった並びを1文字ずつ呈示します。</strong></p>
    <p style="text-align: left">あなたの課題は、それらを覚えて、<b>数字を小さい順に</b>、つづいて<b>アルファベットをアルファベット順に</b>並び替えて回答欄に入力することです。</p>
    <p><br></p>
    <p style="text-align: left">【例題】</p>
    <p style="text-align: left">呈示された文字列: <code>B 3 D 1</code></p>
    <p style="text-align: left">→ 正しい答え: <code>1 3 B D</code> → <code>13BD</code> と入力</p>
    <p><br></p>
    <p style="text-align: left"><b>問題に取り組む時は、メモ書きなどをしないで課題に取り組んでください。</b></p>
    <p style="text-align: left">内容を理解したら、「次へ」ボタンを押して、練習課題に取り組んでください。</p>
    <p><br></p>
  `
]

const practice_task_inst_tl = {
  type: jsPsychInstructions,
  pages: practice_task_inst,
  show_clickable_nav: true,
  button_label_previous: "前へ",
  button_label_next: "次へ",
  data: { task: 'practice_task_inst_tl' },
};

// 練習試行セクション
const practice_trials_tl = {timeline: practice_trials.map((trial) => generateTrial(trial.stimulus, trial.correct, true))};

main_task_inst = [
  `
    <p style="text-align: left">次の画面から、本番に移ります。休憩をとる場合はこの画面でとってください。</strong></p>
    <p style="text-align: left">本番課題では、練習課題と異なり、正誤のフィードバックは呈示されません。</strong></p>
    <p><br></p>
    <p style="text-align: left">以下に、課題の教示と例題に対する回答をあらためて呈示しますので、内容を確認して、準備ができたら</p>
    <p style="text-align: left">「次へ」ボタンを押して、本番課題に取り組んでください。</p>
    <p><br></p>
    <p style="text-align: left">あなたの課題は、それらを覚えて、<b>数字を小さい順に</b>、つづいて<b>アルファベットをアルファベット順に</b>並び替えて回答欄に入力することです。</p>
    <p><br></p>
    <p style="text-align: left">【例題】</p>
    <p style="text-align: left">読み上げられた文字列: <code>B 3 D 1</code></p>
    <p style="text-align: left">→ 正しい答え: <code>1 3 B D</code> → <code>13BD</code> と入力</p>
    <p><br></p>
  `
]

const main_task_inst_tl = {
  type: jsPsychInstructions,
  pages: main_task_inst,
  show_clickable_nav: true,
  button_label_previous: "前へ",
  button_label_next: "次へ",
  data: { task: 'main_task_inst_tl' },
};

// 本番試行セクション
const main_trials_tl = {timeline: main_trials.map((trial) => generateTrial(trial.stimulus, trial.correct, false))};

const debrief = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus:
    "<p style='text-algin:left'>これで事前課題は終了になります。</p>" +
    "<p style='text-algin:left'>次に、文章産出課題の説明に移ります。</p>" + 
    "<p style='text-algin:left'>準備ができたらスペースキーを押して、文章産出課題に進んでください。</p>",
  choices: [' '],
  data: { task: 'debrief' },
  on_finish:function(data){
    const ex_finish_time = new Date();
    const ex_finish_time_text = ex_finish_time.getFullYear()+"/"+(ex_finish_time.getMonth()+1)+"/"+ex_finish_time.getDate()+ " "+ ex_finish_time.getHours()+":"+("0" + ex_finish_time.getMinutes()).slice(-2)+":"+("0" + ex_finish_time.getSeconds()).slice(-2);
    jsPsych.data.addProperties({"EndTime":ex_finish_time_text});
  }
};

jsPsych.run([
  FullScreen,
  practice_task_inst_tl,
  practice_trials_tl,
  main_task_inst_tl,
  main_trials_tl,
  debrief
]);

</script>
</html>